# 告警管理使用指南

## 功能概述

告警管理系统允许您为设备数据设置阈值，当数据超出设定范围时自动触发告警通知。

## 主要功能

### 1. 通知渠道配置

在使用告警功能前，建议先配置通知渠道。

#### 配置通知渠道
1. 进入"告警管理"标签页
2. 点击"通知设置"按钮
3. 选择要配置的通知渠道标签页

#### 邮件通知配置
1. 勾选"启用邮件通知"
2. 填写SMTP服务器信息：
   - **SMTP服务器**: 邮件服务商的SMTP地址（如 smtp.gmail.com）
   - **SMTP端口**: 通常为587（TLS）或465（SSL）
   - **使用SSL/TLS**: 根据服务商要求勾选
   - **发件人邮箱**: 发送告警邮件的邮箱地址
   - **邮箱用户名**: 通常是邮箱地址
   - **邮箱密码/授权码**: SMTP密码或授权码
3. 点击"保存配置"
4. 点击"发送测试"验证配置是否正确

**常见邮箱配置**：
- **Gmail**: smtp.gmail.com:587, 需要应用专用密码
- **QQ邮箱**: smtp.qq.com:587, 需要授权码
- **163邮箱**: smtp.163.com:465, 需要授权码
- **Outlook**: smtp.office365.com:587

#### 短信通知配置
1. 勾选"启用短信通知"
2. 填写短信服务商API信息：
   - **API地址**: 短信服务商的API接口地址
   - **API密钥**: 您的API密钥
   - **签名名称**: 短信签名
   - **模板代码**: 短信模板代码
3. 点击"保存配置"
4. 点击"发送测试"验证配置

**支持的短信服务商**：
- 阿里云短信
- 腾讯云短信
- 其他支持HTTP API的短信服务商

#### 企业微信通知配置
1. 在企业微信群聊中添加"群机器人"
2. 选择"自定义机器人"
3. 复制Webhook地址
4. 在系统中勾选"启用企业微信通知"
5. 粘贴Webhook地址
6. 点击"保存配置"
7. 点击"发送测试"验证配置

#### 钉钉通知配置
1. 在钉钉群聊中添加"自定义机器人"
2. 设置安全设置（建议使用加签方式）
3. 复制Webhook地址
4. 在系统中勾选"启用钉钉通知"
5. 粘贴Webhook地址
6. 点击"保存配置"
7. 点击"发送测试"验证配置

### 2. 告警规则管理

#### 创建告警规则
1. 进入"告警管理"标签页
2. 点击"添加规则"按钮
3. 填写规则信息：
   - **规则名称**: 为规则起一个描述性的名称（如"温度过高告警"）
   - **选择设备**: 选择要监控的设备
   - **告警条件**: 选择触发条件
     - 大于 (>)
     - 大于等于 (>=)
     - 小于 (<)
     - 小于等于 (<=)
     - 等于 (=)
     - 不等于 (≠)
   - **阈值**: 设置触发告警的数值
   - **告警级别**: 
     - 信息 (Info): 一般性提示
     - 警告 (Warning): 需要关注的情况
     - 严重 (Critical): 紧急情况
   - **启用规则**: 勾选以启用该规则

4. 配置通知方式（可选）：
   - **邮件通知**: 输入接收告警的邮箱地址（多个用逗号分隔）
   - **短信通知**: 输入接收告警的手机号（多个用逗号分隔）
   - **企业微信通知**: 勾选后将发送到配置的企业微信群
   - **钉钉通知**: 勾选后将发送到配置的钉钉群

5. 点击"保存"完成创建

**注意**：
- 邮件和短信通知需要先在"通知设置"中配置相应的服务
- 企业微信和钉钉通知需要先配置Webhook地址
- 如果不配置任何通知方式，告警仍会在系统中显示

#### 编辑告警规则
1. 在告警规则表格中找到要编辑的规则
2. 点击"编辑"按钮
3. 修改规则信息
4. 点击"保存"

#### 删除告警规则
1. 在告警规则表格中找到要删除的规则
2. 点击"删除"按钮
3. 确认删除操作

### 3. 活动告警监控

#### 查看活动告警
- 在"活动告警"区域可以看到当前所有触发的告警
- 告警按级别显示不同的颜色：
  - 🔴 红色：严重告警
  - 🟡 黄色：警告告警
  - 🔵 蓝色：信息告警

#### 确认告警
1. 在活动告警列表中找到要确认的告警
2. 点击"确认"按钮
3. 告警将标记为"已确认"状态

#### 清除所有告警
- 点击"清除所有告警"按钮可以清除所有活动告警
- 注意：这不会删除告警规则，只是清除当前的告警状态

### 4. 告警统计

页面顶部显示实时告警统计：
- **严重告警**: 当前严重级别告警数量
- **警告告警**: 当前警告级别告警数量
- **信息告警**: 当前信息级别告警数量
- **活动告警**: 当前所有活动告警总数

### 5. 告警历史

- 查看最近50条告警历史记录
- 显示告警触发时间和恢复时间
- 点击"刷新"按钮更新历史记录

### 6. 实时通知

当告警触发或恢复时，系统会通过多种方式发送通知：

#### 页面通知
- 在页面右上角显示弹窗通知
- 🚨 告警触发通知（根据级别显示不同颜色）
- ✅ 告警恢复通知（绿色）
- 通知会在5秒后自动消失

#### 邮件通知
- 发送HTML格式的告警邮件
- 包含完整的告警信息和设备状态
- 支持多个收件人

#### 短信通知
- 发送简洁的告警短信
- 适合紧急告警通知
- 支持多个手机号

#### 企业微信通知
- 发送Markdown格式的告警消息到企业微信群
- 支持@所有人功能
- 实时推送到手机端

#### 钉钉通知
- 发送Markdown格式的告警消息到钉钉群
- 支持@所有人功能
- 实时推送到手机端

## 使用示例

### 示例1: 温度监控告警（带邮件通知）

假设您有一个温度传感器设备，需要在温度超过80度时发出警告并发送邮件：

1. 配置邮件通知（首次使用）：
   - 进入"告警管理" > "通知设置"
   - 配置SMTP服务器信息
   - 测试邮件发送

2. 创建告警规则：
   - 规则名称: "温度过高告警"
   - 选择设备: "温度传感器01"
   - 告警条件: "大于 (>)"
   - 阈值: 80
   - 告警级别: "警告"
   - 邮件通知: "admin@example.com, operator@example.com"
   - 启用规则: ✓

3. 当温度传感器读数超过80度时：
   - 系统自动触发告警
   - 在活动告警列表中显示
   - 页面右上角弹出通知
   - 发送邮件到指定邮箱
   - 控制台输出告警信息

4. 当温度降回80度以下时：
   - 系统自动恢复告警
   - 从活动告警列表中移除
   - 显示恢复通知
   - 发送恢复邮件（可选）

### 示例2: 压力监控告警（多渠道通知）

监控压力值，设置上下限告警，使用多种通知方式：

**上限告警（严重）**:
- 规则名称: "压力过高告警"
- 选择设备: "压力传感器01"
- 告警条件: "大于等于 (>=)"
- 阈值: 100
- 告警级别: "严重"
- 邮件通知: "admin@example.com"
- 短信通知: "13800138000"
- 企业微信通知: ✓
- 钉钉通知: ✓

**下限告警（警告）**:
- 规则名称: "压力过低告警"
- 选择设备: "压力传感器01"
- 告警条件: "小于 (<)"
- 阈值: 20
- 告警级别: "警告"
- 邮件通知: "operator@example.com"
- 企业微信通知: ✓

## 最佳实践

1. **合理设置阈值**: 根据实际业务需求设置合适的阈值，避免频繁误报
2. **使用描述性名称**: 为告警规则起一个清晰的名称，便于识别
3. **区分告警级别**: 
   - 严重：需要立即处理的紧急情况，使用所有通知渠道
   - 警告：需要关注但不紧急的情况，使用邮件和企业微信/钉钉
   - 信息：一般性提示，仅在系统中显示
4. **选择合适的通知方式**:
   - 严重告警：邮件 + 短信 + 企业微信/钉钉
   - 警告告警：邮件 + 企业微信/钉钉
   - 信息告警：仅系统通知
5. **避免通知疲劳**: 不要为所有告警都配置短信通知，以免造成骚扰
6. **及时确认告警**: 处理完告警后及时确认，保持告警列表清晰
7. **定期检查规则**: 定期审查和更新告警规则，确保其有效性
8. **测试通知配置**: 配置完成后使用"发送测试"功能验证通知是否正常

## 技术说明

### 告警检测机制
- 告警检测在数据采集时实时进行
- 每次采集到新数据时，系统会检查所有相关的告警规则
- 告警状态通过 WebSocket 实时推送到前端

### 告警状态
- **触发**: 数据满足告警条件
- **恢复**: 数据不再满足告警条件
- **已确认**: 用户已确认该告警

### 数据存储
- 告警规则存储在数据库中
- 活动告警和历史记录保存在内存中
- 系统重启后活动告警会清空，但规则会保留

## 故障排除

### 告警未触发
1. 检查告警规则是否已启用
2. 确认设备数据采集正常
3. 验证阈值和条件设置是否正确
4. 查看控制台是否有错误信息

### 告警通知未显示
1. 检查浏览器是否阻止了通知
2. 确认 WebSocket 连接正常
3. 刷新页面重新连接

### 邮件通知未收到
1. 检查邮件配置是否正确
2. 确认SMTP服务器地址和端口
3. 验证邮箱用户名和密码/授权码
4. 检查收件箱的垃圾邮件文件夹
5. 使用"发送测试"功能测试邮件配置
6. 查看服务器控制台的错误信息

### 短信通知未收到
1. 检查短信配置是否正确
2. 确认API密钥有效
3. 验证手机号格式正确
4. 检查短信服务商账户余额
5. 查看服务器控制台的错误信息

### 企业微信/钉钉通知未收到
1. 检查Webhook地址是否正确
2. 确认机器人未被禁用
3. 验证网络连接正常
4. 使用"发送测试"功能测试配置
5. 查看服务器控制台的错误信息

### 告警规则无法保存
1. 检查所有必填字段是否已填写
2. 确认设备ID有效
3. 验证邮箱和手机号格式
4. 查看浏览器控制台错误信息

## API 接口

如需通过 API 管理告警，可参考以下接口：

### 告警规则管理
- `GET /api/alarms/rules` - 获取所有告警规则
- `POST /api/alarms/rules` - 创建告警规则
- `PUT /api/alarms/rules/:id` - 更新告警规则
- `DELETE /api/alarms/rules/:id` - 删除告警规则

### 告警状态管理
- `GET /api/alarms/active` - 获取活动告警
- `GET /api/alarms/history` - 获取告警历史
- `GET /api/alarms/stats` - 获取告警统计
- `POST /api/alarms/acknowledge/:deviceId/:ruleId` - 确认告警
- `POST /api/alarms/clear` - 清除所有告警

### 通知配置管理
- `GET /api/notifications/config` - 获取通知配置
- `POST /api/notifications/config/:type` - 保存通知配置（type: email/sms/wecom/dingtalk）
- `POST /api/notifications/test` - 发送测试通知

## 通知配置文件

系统支持通过环境变量配置通知服务，参考 `.env.notification.example` 文件：

```bash
# 邮件配置
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your-email@gmail.com
EMAIL_PASSWORD=your-app-password

# 企业微信配置
WECOM_WEBHOOK_URL=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your-key

# 钉钉配置
DINGTALK_WEBHOOK_URL=https://oapi.dingtalk.com/robot/send?access_token=your-token
```
