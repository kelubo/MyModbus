# åˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²æŒ‡å—

## ğŸ“– æ¦‚è¿°

Modbus RTU Manager æ”¯æŒåˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²ï¼Œå¯ä»¥å°†è®¾å¤‡é‡‡é›†ä»»åŠ¡åˆ†é…åˆ°å¤šä¸ªèŠ‚ç‚¹ï¼Œæé«˜ç³»ç»Ÿçš„å¯é æ€§å’Œæ‰©å±•æ€§ã€‚

## ğŸ—ï¸ æ¶æ„è¯´æ˜

### å•æœºæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Modbus Manager    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Web Server  â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚   Database    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Data Collectorâ”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é›†ç¾¤æ¨¡å¼

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Redis   â”‚
                    â”‚ (æ¶ˆæ¯é˜Ÿåˆ—) â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚ Node 1  â”‚      â”‚ Node 2  â”‚     â”‚ Node 3  â”‚
   â”‚ (Master)â”‚      â”‚ (Worker)â”‚     â”‚ (Worker)â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚Web+Data â”‚      â”‚  Data   â”‚     â”‚  Data   â”‚
   â”‚Collectorâ”‚      â”‚Collectorâ”‚     â”‚Collectorâ”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                â”‚                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                    â”‚ Database â”‚
                    â”‚(MySQL/PG)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ææ¡ä»¶

1. **Redis æœåŠ¡å™¨**
   - ç”¨äºèŠ‚ç‚¹é—´é€šä¿¡å’Œä»»åŠ¡åˆ†é…
   - ç‰ˆæœ¬è¦æ±‚: >= 5.0

2. **å…±äº«æ•°æ®åº“**
   - MySQL æˆ– PostgreSQL
   - SQLite ä¸æ”¯æŒé›†ç¾¤æ¨¡å¼

### å®‰è£… Redis

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install redis-server
sudo systemctl start redis
sudo systemctl enable redis
```

**CentOS/RHEL:**
```bash
sudo yum install redis
sudo systemctl start redis
sudo systemctl enable redis
```

**Windows:**
ä¸‹è½½å¹¶å®‰è£… [Redis for Windows](https://github.com/microsoftarchive/redis/releases)

**Docker:**
```bash
docker run -d --name redis -p 6379:6379 redis:latest
```

### é…ç½®é›†ç¾¤

#### 1. é…ç½®ä¸»èŠ‚ç‚¹ï¼ˆMasterï¼‰

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=production

# é›†ç¾¤é…ç½®
CLUSTER_ENABLED=true
NODE_ID=master-node-1
NODE_ROLE=both  # æ—¢å¤„ç† Web è¯·æ±‚ï¼Œä¹Ÿé‡‡é›†æ•°æ®

# Redis é…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# æ•°æ®åº“é…ç½®ï¼ˆä½¿ç”¨ MySQLï¼‰
DB_TYPE=mysql
DB_HOST=localhost
DB_PORT=3306
DB_USER=modbus_user
DB_PASSWORD=your_password
DB_NAME=modbus_manager
```

å¯åŠ¨ä¸»èŠ‚ç‚¹ï¼š
```bash
node server.js
```

#### 2. é…ç½®å·¥ä½œèŠ‚ç‚¹ï¼ˆWorkerï¼‰

åœ¨å¦ä¸€å°æœåŠ¡å™¨ä¸Šåˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# æœåŠ¡å™¨é…ç½®
PORT=3001  # ä¸åŒçš„ç«¯å£
NODE_ENV=production

# é›†ç¾¤é…ç½®
CLUSTER_ENABLED=true
NODE_ID=worker-node-1
NODE_ROLE=worker  # åªé‡‡é›†æ•°æ®

# Redis é…ç½®ï¼ˆæŒ‡å‘ä¸»èŠ‚ç‚¹çš„ Redisï¼‰
REDIS_HOST=192.168.1.100  # ä¸»èŠ‚ç‚¹ IP
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# æ•°æ®åº“é…ç½®ï¼ˆè¿æ¥åˆ°åŒä¸€ä¸ªæ•°æ®åº“ï¼‰
DB_TYPE=mysql
DB_HOST=192.168.1.100  # æ•°æ®åº“æœåŠ¡å™¨ IP
DB_PORT=3306
DB_USER=modbus_user
DB_PASSWORD=your_password
DB_NAME=modbus_manager
```

å¯åŠ¨å·¥ä½œèŠ‚ç‚¹ï¼š
```bash
node server.js
```

#### 3. æ·»åŠ æ›´å¤šèŠ‚ç‚¹

é‡å¤æ­¥éª¤ 2ï¼Œä¿®æ”¹ `NODE_ID` å’Œ `PORT`ã€‚

## âš™ï¸ é…ç½®è¯´æ˜

### èŠ‚ç‚¹è§’è‰²

| è§’è‰² | è¯´æ˜ | åŠŸèƒ½ |
|-----|------|------|
| `master` | ä¸»èŠ‚ç‚¹ | åªå¤„ç† Web è¯·æ±‚å’Œç®¡ç†ä»»åŠ¡ |
| `worker` | å·¥ä½œèŠ‚ç‚¹ | åªæ‰§è¡Œæ•°æ®é‡‡é›†ä»»åŠ¡ |
| `both` | æ··åˆèŠ‚ç‚¹ | æ—¢å¤„ç† Web è¯·æ±‚ï¼Œä¹Ÿé‡‡é›†æ•°æ® |

### ä»»åŠ¡åˆ†é…ç­–ç•¥

| ç­–ç•¥ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|-----|------|---------|
| `round-robin` | è½®è¯¢åˆ†é… | èŠ‚ç‚¹æ€§èƒ½ç›¸è¿‘ |
| `least-loaded` | è´Ÿè½½æœ€ä½ä¼˜å…ˆ | èŠ‚ç‚¹æ€§èƒ½ä¸åŒ |
| `hash` | åŸºäºè®¾å¤‡IDå“ˆå¸Œ | éœ€è¦å›ºå®šåˆ†é… |

é…ç½®æ–¹å¼ï¼š
```bash
TASK_STRATEGY=round-robin
```

### Redis é…ç½®

```bash
# Redis æœåŠ¡å™¨åœ°å€
REDIS_HOST=localhost

# Redis ç«¯å£
REDIS_PORT=6379

# Redis å¯†ç ï¼ˆå¦‚æœæœ‰ï¼‰
REDIS_PASSWORD=your_redis_password

# Redis æ•°æ®åº“ç¼–å·
REDIS_DB=0
```

## ğŸ“Š ç›‘æ§å’Œç®¡ç†

### æŸ¥çœ‹é›†ç¾¤çŠ¶æ€

è®¿é—® API ç«¯ç‚¹ï¼š

```bash
# é›†ç¾¤çŠ¶æ€
curl http://localhost:3000/api/cluster/status

# æ´»è·ƒèŠ‚ç‚¹åˆ—è¡¨
curl http://localhost:3000/api/cluster/nodes
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "mode": "cluster",
  "nodes": 3,
  "currentNode": "master-node-1",
  "activeNodes": [
    {
      "id": "master-node-1",
      "role": "both",
      "hostname": "server1",
      "cpus": 4,
      "load": 0.5,
      "uptime": 3600
    },
    {
      "id": "worker-node-1",
      "role": "worker",
      "hostname": "server2",
      "cpus": 2,
      "load": 0.3,
      "uptime": 3500
    }
  ],
  "totalTasks": 10,
  "taskDistribution": {
    "master-node-1": 5,
    "worker-node-1": 5
  }
}
```

### èŠ‚ç‚¹å¥åº·æ£€æŸ¥

æ¯ä¸ªèŠ‚ç‚¹æ¯ 5 ç§’å‘é€ä¸€æ¬¡å¿ƒè·³ï¼Œè¶…è¿‡ 15 ç§’æœªæ”¶åˆ°å¿ƒè·³çš„èŠ‚ç‚¹ä¼šè¢«æ ‡è®°ä¸ºç¦»çº¿ã€‚

### ä»»åŠ¡é‡æ–°åˆ†é…

å½“èŠ‚ç‚¹ç¦»çº¿æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†å…¶ä»»åŠ¡é‡æ–°åˆ†é…ç»™å…¶ä»–æ´»è·ƒèŠ‚ç‚¹ã€‚

## ğŸ”§ éƒ¨ç½²æ¶æ„

### å°å‹é›†ç¾¤ï¼ˆ2-3 èŠ‚ç‚¹ï¼‰

```
æ¨èé…ç½®:
- 1 ä¸ª Master èŠ‚ç‚¹ï¼ˆboth è§’è‰²ï¼‰
- 1-2 ä¸ª Worker èŠ‚ç‚¹
- 1 ä¸ª Redis å®ä¾‹
- 1 ä¸ª MySQL/PostgreSQL å®ä¾‹

é€‚ç”¨åœºæ™¯:
- 10-50 ä¸ªè®¾å¤‡
- ä¸­ç­‰æ•°æ®é‡
```

### ä¸­å‹é›†ç¾¤ï¼ˆ4-10 èŠ‚ç‚¹ï¼‰

```
æ¨èé…ç½®:
- 1-2 ä¸ª Master èŠ‚ç‚¹ï¼ˆmaster è§’è‰²ï¼‰
- 3-8 ä¸ª Worker èŠ‚ç‚¹
- 1 ä¸ª Redis å®ä¾‹ï¼ˆæˆ– Redis Sentinelï¼‰
- 1 ä¸ª MySQL/PostgreSQL å®ä¾‹ï¼ˆä¸»ä»å¤åˆ¶ï¼‰

é€‚ç”¨åœºæ™¯:
- 50-200 ä¸ªè®¾å¤‡
- å¤§é‡æ•°æ®
```

### å¤§å‹é›†ç¾¤ï¼ˆ10+ èŠ‚ç‚¹ï¼‰

```
æ¨èé…ç½®:
- 2-3 ä¸ª Master èŠ‚ç‚¹ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
- 10+ ä¸ª Worker èŠ‚ç‚¹
- Redis Clusterï¼ˆé«˜å¯ç”¨ï¼‰
- PostgreSQL é›†ç¾¤ï¼ˆä¸»ä»å¤åˆ¶ + è¯»å†™åˆ†ç¦»ï¼‰

é€‚ç”¨åœºæ™¯:
- 200+ ä¸ªè®¾å¤‡
- æµ·é‡æ•°æ®
- é«˜å¯ç”¨è¦æ±‚
```

## ğŸŒ è´Ÿè½½å‡è¡¡

### ä½¿ç”¨ Nginx

é…ç½®ç¤ºä¾‹ï¼š

```nginx
upstream modbus_cluster {
    least_conn;
    server 192.168.1.100:3000;
    server 192.168.1.101:3000;
    server 192.168.1.102:3000;
}

server {
    listen 80;
    server_name modbus.example.com;

    location / {
        proxy_pass http://modbus_cluster;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    location /ws {
        proxy_pass http://modbus_cluster;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }
}
```

## ğŸ” å®‰å…¨å»ºè®®

1. **Redis å®‰å…¨**
   - è®¾ç½®å¼ºå¯†ç 
   - ç»‘å®šåˆ°å†…ç½‘ IP
   - ä½¿ç”¨é˜²ç«å¢™é™åˆ¶è®¿é—®

2. **æ•°æ®åº“å®‰å…¨**
   - ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“ç”¨æˆ·
   - é™åˆ¶ç½‘ç»œè®¿é—®
   - å¯ç”¨ SSL è¿æ¥

3. **èŠ‚ç‚¹é€šä¿¡**
   - ä½¿ç”¨ VPN æˆ–ä¸“ç”¨ç½‘ç»œ
   - é…ç½®é˜²ç«å¢™è§„åˆ™
   - å®šæœŸæ›´æ–°ç³»ç»Ÿ

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### Redis ä¼˜åŒ–

```bash
# redis.conf
maxmemory 2gb
maxmemory-policy allkeys-lru
save ""  # ç¦ç”¨æŒä¹…åŒ–ï¼ˆå¯é€‰ï¼‰
```

### æ•°æ®åº“ä¼˜åŒ–

```sql
-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_device_timestamp ON data(device_id, timestamp);
CREATE INDEX idx_timestamp ON data(timestamp);

-- å®šæœŸæ¸…ç†æ—§æ•°æ®
DELETE FROM data WHERE timestamp < UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 30 DAY)) * 1000;
```

### èŠ‚ç‚¹ä¼˜åŒ–

- æ ¹æ®è®¾å¤‡æ•°é‡è°ƒæ•´èŠ‚ç‚¹æ•°
- ä½¿ç”¨ SSD å­˜å‚¨
- å¢åŠ å†…å­˜
- ä¼˜åŒ–ç½‘ç»œè¿æ¥

## ğŸ”„ æ•…éšœæ¢å¤

### èŠ‚ç‚¹æ•…éšœ

1. èŠ‚ç‚¹è‡ªåŠ¨ä»é›†ç¾¤ä¸­ç§»é™¤
2. ä»»åŠ¡è‡ªåŠ¨é‡æ–°åˆ†é…
3. ä¿®å¤èŠ‚ç‚¹åé‡æ–°åŠ å…¥

### Redis æ•…éšœ

1. èŠ‚ç‚¹åˆ‡æ¢åˆ°å•æœºæ¨¡å¼
2. ç»§ç»­é‡‡é›†æ•°æ®
3. Redis æ¢å¤åè‡ªåŠ¨é‡æ–°è¿æ¥

### æ•°æ®åº“æ•…éšœ

1. åœæ­¢æ•°æ®é‡‡é›†
2. ç¼“å­˜æ•°æ®åˆ°æœ¬åœ°
3. æ•°æ®åº“æ¢å¤ååŒæ­¥æ•°æ®

## ğŸ§ª æµ‹è¯•é›†ç¾¤

### 1. å¯åŠ¨æµ‹è¯•ç¯å¢ƒ

```bash
# å¯åŠ¨ Redis
docker run -d --name redis -p 6379:6379 redis

# å¯åŠ¨ MySQL
docker run -d --name mysql \
  -e MYSQL_ROOT_PASSWORD=password \
  -e MYSQL_DATABASE=modbus_manager \
  -p 3306:3306 mysql:8

# å¯åŠ¨èŠ‚ç‚¹ 1
CLUSTER_ENABLED=true NODE_ID=node-1 NODE_ROLE=both PORT=3000 node server.js

# å¯åŠ¨èŠ‚ç‚¹ 2
CLUSTER_ENABLED=true NODE_ID=node-2 NODE_ROLE=worker PORT=3001 node server.js
```

### 2. éªŒè¯é›†ç¾¤

```bash
# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
curl http://localhost:3000/api/cluster/status

# æŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨
curl http://localhost:3000/api/cluster/nodes
```

### 3. æµ‹è¯•æ•…éšœè½¬ç§»

```bash
# åœæ­¢èŠ‚ç‚¹ 2
# è§‚å¯Ÿä»»åŠ¡æ˜¯å¦é‡æ–°åˆ†é…åˆ°èŠ‚ç‚¹ 1
```

## ğŸ“ æœ€ä½³å®è·µ

1. **ä½¿ç”¨å…±äº«æ•°æ®åº“**
   - æ‰€æœ‰èŠ‚ç‚¹è¿æ¥åŒä¸€ä¸ªæ•°æ®åº“
   - æ¨èä½¿ç”¨ MySQL æˆ– PostgreSQL

2. **åˆç†åˆ†é…è§’è‰²**
   - Master èŠ‚ç‚¹å¤„ç† Web è¯·æ±‚
   - Worker èŠ‚ç‚¹ä¸“æ³¨æ•°æ®é‡‡é›†

3. **ç›‘æ§èŠ‚ç‚¹çŠ¶æ€**
   - å®šæœŸæ£€æŸ¥èŠ‚ç‚¹å¥åº·
   - è®¾ç½®å‘Šè­¦æœºåˆ¶

4. **å®šæœŸå¤‡ä»½**
   - å¤‡ä»½ Redis æ•°æ®
   - å¤‡ä»½æ•°æ®åº“

5. **é€æ­¥æ‰©å±•**
   - ä»å°è§„æ¨¡å¼€å§‹
   - æ ¹æ®è´Ÿè½½é€æ­¥æ·»åŠ èŠ‚ç‚¹

## ğŸ†š å•æœº vs é›†ç¾¤

| ç‰¹æ€§ | å•æœºæ¨¡å¼ | é›†ç¾¤æ¨¡å¼ |
|-----|---------|---------|
| é…ç½®éš¾åº¦ | â­ | â­â­â­â­ |
| å¯é æ€§ | â­â­ | â­â­â­â­â­ |
| æ‰©å±•æ€§ | â­ | â­â­â­â­â­ |
| æ€§èƒ½ | â­â­â­ | â­â­â­â­â­ |
| ç»´æŠ¤æˆæœ¬ | â­ | â­â­â­â­ |
| é€‚ç”¨è®¾å¤‡æ•° | < 50 | æ— é™åˆ¶ |

## ğŸ“ æ•…éšœæ’æŸ¥

### èŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤

**æ£€æŸ¥ï¼š**
1. Redis æ˜¯å¦å¯è®¿é—®
2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
3. é…ç½®æ˜¯å¦æ­£ç¡®

### ä»»åŠ¡åˆ†é…ä¸å‡

**è§£å†³ï¼š**
1. æ£€æŸ¥èŠ‚ç‚¹è´Ÿè½½
2. è°ƒæ•´åˆ†é…ç­–ç•¥
3. å¢åŠ èŠ‚ç‚¹æ•°é‡

### æ•°æ®ä¸åŒæ­¥

**è§£å†³ï¼š**
1. æ£€æŸ¥æ•°æ®åº“è¿æ¥
2. éªŒè¯èŠ‚ç‚¹æ—¶é—´åŒæ­¥
3. æŸ¥çœ‹é”™è¯¯æ—¥å¿—

---

**éœ€è¦å¸®åŠ©ï¼Ÿ** æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶æˆ–è”ç³»æŠ€æœ¯æ”¯æŒï¼
