# 集群监控使用指南

## 功能概述

系统监控页面集成了集群节点状态监控功能，可以实时查看所有集群节点的运行状态、资源使用情况和任务分配信息。

## 监控功能

### 1. 集群状态概览

在系统监控页面顶部显示集群整体状态：

- **运行模式**: 显示当前是单机模式还是集群模式
- **活动节点**: 当前集群中活动节点的数量
- **当前节点**: 显示当前访问的节点ID
- **任务总数**: 集群中分配的任务总数

### 2. 节点列表

详细显示每个节点的信息：

| 字段 | 说明 |
|------|------|
| 节点ID | 节点的唯一标识符 |
| 角色 | 主节点/工作节点/混合节点 |
| 主机名 | 节点所在服务器的主机名 |
| CPU核心 | CPU核心数量 |
| 内存 | 总内存和可用内存（GB） |
| 负载 | 系统负载（1分钟平均值） |
| 运行时间 | 节点已运行时间 |
| 最后心跳 | 最后一次心跳时间 |
| 状态 | 健康/异常 |

#### 节点角色说明

- **主节点** (Master): 负责协调和管理集群
- **工作节点** (Worker): 负责执行数据采集任务
- **混合节点** (Both): 同时具有主节点和工作节点功能

#### 节点状态

- **健康** (绿色): 节点正常运行，心跳正常
- **异常** (红色): 节点心跳超时或离线

### 3. 任务分配

可视化显示任务在各节点间的分配情况：

- 每个节点分配的任务数量
- 任务分配百分比
- 进度条显示任务分布

### 4. 本地系统信息

显示当前访问节点的详细系统信息：

- CPU使用率和核心数
- 内存使用情况
- 操作系统信息
- 磁盘使用情况
- 网络接口信息

## 使用场景

### 场景1: 监控集群健康状态

1. 进入"系统监控"标签页
2. 查看"集群状态"区域
3. 检查活动节点数量是否正常
4. 查看节点列表，确认所有节点状态为"健康"

### 场景2: 检查节点负载

1. 查看节点列表中的"负载"列
2. 识别负载较高的节点
3. 根据需要调整任务分配策略或增加节点

### 场景3: 排查节点故障

1. 在节点列表中找到状态为"异常"的节点
2. 查看"最后心跳"时间，判断节点离线时长
3. 检查该节点的任务分配情况
4. 登录到故障节点进行排查

### 场景4: 优化任务分配

1. 查看"任务分配"区域
2. 分析任务分布是否均衡
3. 如果分布不均，可以调整集群配置中的任务分配策略
4. 重启服务使新配置生效

## 集群配置

### 启用集群模式

编辑 `config/cluster.config.js`:

```javascript
module.exports = {
  enabled: true,  // 启用集群模式
  
  redis: {
    host: '127.0.0.1',
    port: 6379,
    password: '',
    db: 0
  },
  
  node: {
    id: 'node-1',        // 节点ID，每个节点必须唯一
    role: 'both'         // 节点角色: master/worker/both
  },
  
  heartbeat: {
    interval: 5000,      // 心跳间隔（毫秒）
    timeout: 15000       // 心跳超时（毫秒）
  },
  
  taskAllocation: {
    strategy: 'least-loaded'  // 任务分配策略
  }
};
```

### 任务分配策略

系统支持三种任务分配策略：

1. **round-robin** (轮询)
   - 按顺序将任务分配给各个节点
   - 适合节点性能相近的场景

2. **least-loaded** (最小负载)
   - 将任务分配给负载最低的节点
   - 适合节点性能不同的场景
   - 推荐使用

3. **hash** (哈希)
   - 根据设备ID哈希分配到固定节点
   - 保证同一设备始终由同一节点处理
   - 适合需要状态保持的场景

### 部署多节点集群

#### 节点1 (主节点)

```javascript
// config/cluster.config.js
module.exports = {
  enabled: true,
  redis: {
    host: '192.168.1.100',  // Redis服务器地址
    port: 6379
  },
  node: {
    id: 'master-node-1',
    role: 'master'
  }
};
```

#### 节点2 (工作节点)

```javascript
// config/cluster.config.js
module.exports = {
  enabled: true,
  redis: {
    host: '192.168.1.100',  // 同一个Redis服务器
    port: 6379
  },
  node: {
    id: 'worker-node-1',
    role: 'worker'
  }
};
```

#### 节点3 (工作节点)

```javascript
// config/cluster.config.js
module.exports = {
  enabled: true,
  redis: {
    host: '192.168.1.100',
    port: 6379
  },
  node: {
    id: 'worker-node-2',
    role: 'worker'
  }
};
```

## 监控指标说明

### CPU负载

- **正常**: < 1.0 (单核)
- **警告**: 1.0 - 2.0
- **严重**: > 2.0

### 内存使用

- **正常**: < 70%
- **警告**: 70% - 85%
- **严重**: > 85%

### 心跳超时

- **正常**: < 10秒
- **警告**: 10 - 30秒
- **严重**: > 30秒（节点标记为异常）

## 最佳实践

1. **定期检查**: 每天至少检查一次集群状态
2. **监控告警**: 配置告警规则监控节点状态
3. **负载均衡**: 保持各节点负载相对均衡
4. **冗余部署**: 至少部署3个节点以保证高可用
5. **资源预留**: 为节点预留足够的CPU和内存资源
6. **网络稳定**: 确保节点间网络连接稳定
7. **Redis高可用**: 使用Redis哨兵或集群模式

## 故障排除

### 节点显示为异常

**可能原因**:
- 节点进程已停止
- 网络连接中断
- Redis服务不可用
- 节点负载过高导致心跳超时

**解决方法**:
1. 检查节点进程是否运行
2. 测试网络连接
3. 检查Redis服务状态
4. 查看节点日志

### 任务分配不均

**可能原因**:
- 任务分配策略不合适
- 某些节点性能较差
- 节点加入时间不同

**解决方法**:
1. 切换到 `least-loaded` 策略
2. 升级性能较差的节点
3. 重启所有节点重新分配任务

### 节点频繁离线

**可能原因**:
- 心跳间隔设置过短
- 网络不稳定
- 节点资源不足

**解决方法**:
1. 增加心跳超时时间
2. 检查网络质量
3. 增加节点资源

## API接口

### 获取集群状态

```bash
GET /api/cluster/status
```

响应示例:
```json
{
  "mode": "cluster",
  "nodes": 3,
  "currentNode": "master-node-1",
  "totalTasks": 10,
  "taskDistribution": {
    "worker-node-1": 5,
    "worker-node-2": 5
  }
}
```

### 获取节点列表

```bash
GET /api/cluster/nodes
```

响应示例:
```json
[
  {
    "id": "master-node-1",
    "role": "master",
    "hostname": "server-1",
    "cpus": 8,
    "memory": 17179869184,
    "freeMem": 8589934592,
    "load": 0.5,
    "uptime": 86400,
    "lastHeartbeat": 1701234567890
  }
]
```

## 相关文档

- [集群部署指南](CLUSTER_GUIDE.md)
- [系统监控指南](QUICK_START.md)
- [故障排除](INSTALL.md)
